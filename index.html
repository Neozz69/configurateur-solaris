<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Solaire - Solaris Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --solaris-orange: #f5a623;
            --solaris-dark: #333333;
            --grey-bg: #f7f7f7;
            --border-color: #e0e0e0;
            --text-color: #4a4a4a;
        }

        body { font-family: 'Open Sans', sans-serif; background-color: var(--grey-bg); margin: 0; color: var(--text-color); }
        
        /* HEADER STYLE SOLARIS */
        header { background: white; border-bottom: 3px solid var(--solaris-orange); padding: 15px 0; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: 800; color: var(--solaris-dark); text-transform: uppercase; letter-spacing: 1px; }
        .logo span { color: var(--solaris-orange); }

        /* CONTAINER */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* STEPS DESIGN */
        .step-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        h2 { 
            font-size: 18px; 
            text-transform: uppercase; 
            color: var(--solaris-dark); 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px; 
            margin-top: 0;
            display: flex; align-items: center; gap: 10px;
        }
        h2 i { color: var(--solaris-orange); }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px; color: #666; }
        select, input { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 3px; 
            font-family: inherit; font-size: 14px; box-sizing: border-box;
        }
        select:focus, input:focus { border-color: var(--solaris-orange); outline: none; }

        /* TABLE */
        .appliance-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .appliance-table th { background: #f9f9f9; text-align: left; padding: 10px; border-bottom: 2px solid var(--solaris-orange); }
        .appliance-table td { padding: 10px; border-bottom: 1px solid #eee; }
        
        /* BUTTONS */
        .btn { 
            background: var(--solaris-dark); color: white; border: none; padding: 12px 25px; 
            font-weight: 700; text-transform: uppercase; font-size: 13px; cursor: pointer; border-radius: 2px; transition: 0.3s;
        }
        .btn:hover { background: var(--solaris-orange); }
        .btn-add { background: var(--solaris-orange); padding: 8px 15px; font-size: 12px; }
        .btn-calc { width: 100%; font-size: 16px; padding: 15px; margin-top: 20px; }

        /* RESULTS AREA */
        #results-section { display: none; }
        .kit-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        
        .kit-card { 
            background: white; border: 1px solid #eee; border-radius: 5px; overflow: hidden; 
            transition: transform 0.3s; position: relative;
        }
        .kit-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .kit-header { padding: 20px; text-align: center; color: white; }
        .kit-eco .kit-header { background: #7f8c8d; }
        .kit-pro .kit-header { background: var(--solaris-orange); }
        
        .kit-price { font-size: 28px; font-weight: 800; color: var(--solaris-dark); text-align: center; margin: 20px 0; }
        .kit-content { padding: 0 20px 20px 20px; font-size: 14px; line-height: 1.6; }
        .kit-content ul { list-style: none; padding: 0; }
        .kit-content li { border-bottom: 1px dashed #eee; padding: 8px 0; }
        .kit-content li i { color: var(--solaris-orange); width: 20px; }

        /* AI CHATBOT MODERN */
        #ai-widget {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 50px;
            background: white; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; overflow: hidden; transition: 0.4s; z-index: 999;
            font-family: 'Open Sans', sans-serif;
        }
        #ai-widget.open { height: 500px; }
        
        .ai-header {
            background: var(--solaris-dark); color: white; padding: 15px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ai-body { flex: 1; padding: 15px; overflow-y: auto; background: #f4f4f4; display: flex; flex-direction: column; gap: 10px; }
        .ai-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        
        .msg { padding: 10px; border-radius: 8px; font-size: 13px; max-width: 85%; }
        .msg.bot { background: white; border: 1px solid #ddd; align-self: flex-start; }
        .msg.user { background: var(--solaris-orange); color: white; align-self: flex-end; }
        
        /* API KEY SETTINGS */
        #api-key-modal { display:none; position:absolute; top:50px; left:0; right:0; background:rgba(0,0,0,0.9); padding:20px; color:white; z-index:1000; text-align:center; }

    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo">SOLARIS<span>STORE</span></div>
        <div style="margin-left: auto; font-size: 14px; font-weight: 600;">
            <i class="fas fa-phone-alt" style="color:var(--solaris-orange)"></i> 04 74 -- -- --
        </div>
    </div>
</header>

<div class="container">
    
    <div class="step-card">
        <h2><i class="fas fa-map-marker-alt"></i> 1. Localisation du site</h2>
        <div class="form-grid">
            <div>
                <label>Zone d'ensoleillement</label>
                <select id="zone">
                    <option value="0.85">Zone 1 : Nord / Nord-Est (Faible)</option>
                    <option value="1.0" selected>Zone 2 : Centre / Ouest (Moyen)</option>
                    <option value="1.2">Zone 3 : Sud-Ouest / Rhône (Bon)</option>
                    <option value="1.3">Zone 4 : Sud-Est / Corse (Excellent)</option>
                    <option value="1.5">Zone 5 : Afrique / DOM-TOM</option>
                </select>
            </div>
            <div>
                <label>Utilisation</label>
                <select id="period">
                    <option value="1">Annuelle (Habitation principale)</option>
                    <option value="1.2">Estivale (Avril - Octobre)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="step-card">
        <h2><i class="fas fa-plug"></i> 2. Vos besoins électriques</h2>
        
        <div style="background: #fff8e1; padding: 10px; border-left: 3px solid var(--solaris-orange); margin-bottom: 15px; font-size: 13px;">
            Ajoutez vos appareils ci-dessous. L'assistant IA vérifie la cohérence en temps réel.
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select id="quick-add">
                <option value="">-- Ajout Rapide --</option>
                <option value='{"n":"Réfrigérateur A++", "w":60, "h":24}'>Frigo A++ (24h)</option>
                <option value='{"n":"Éclairage LED", "w":40, "h":4}'>Éclairage (4h)</option>
                <option value='{"n":"TV LED", "w":100, "h":3}'>Télévision (3h)</option>
                <option value='{"n":"Chargeurs USB", "w":15, "h":3}'>Chargeurs Tél (3h)</option>
                <option value='{"n":"Pompe Surpresseur", "w":800, "h":0.3}'>Pompe Eau (20min)</option>
                <option value='{"n":"PC Portable", "w":60, "h":5}'>PC Portable (5h)</option>
            </select>
            <button class="btn btn-add" onclick="addPreset()">OK</button>
        </div>

        <table class="appliance-table">
            <thead>
                <tr>
                    <th>Appareil</th>
                    <th width="100">Puissance (W)</th>
                    <th width="100">Heures/jour</th>
                    <th width="50"></th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
        
        <div style="text-align: right; margin-top: 15px; font-weight: bold;">
            Conso Journalière : <span id="total-wh" style="color:var(--solaris-orange)">0</span> Wh/j
        </div>

        <div style="margin-top: 20px;">
            <label>Autonomie souhaitée (Jours sans soleil)</label>
            <select id="autonomy">
                <option value="2">2 Jours (Standard)</option>
                <option value="3">3 Jours (Sécurité)</option>
                <option value="4">4 Jours (Zone montagne/Nord)</option>
            </select>
        </div>

        <button class="btn btn-calc" onclick="calculate()">CALCULER MON KIT</button>
    </div>

    <div id="results-section">
        <h2 style="text-align: center; border:none; font-size: 24px;">Nos Solutions Kit Tout-en-un</h2>
        <p style="text-align: center; color: #666;">Ces kits incluent : Panneaux, Batteries, Onduleur, Câbles (10m), Protections DC/AC et Fixations toiture.</p>
        
        <div class="kit-comparison">
            <div class="kit-card kit-eco">
                <div class="kit-header">
                    <h3>KIT ECO (GEL)</h3>
                    <small>Usage occasionnel / Budget</small>
                </div>
                <div class="kit-price" id="price-lead">-- €</div>
                <div class="kit-content" id="details-lead"></div>
                <div style="padding: 20px;">
                    <button class="btn" style="width:100%; background: #7f8c8d;">Voir le détail</button>
                </div>
            </div>

            <div class="kit-card kit-pro">
                <div class="kit-header">
                    <h3>KIT PREMIUM (LITHIUM)</h3>
                    <small>Usage intensif / Longue durée</small>
                </div>
                <div class="kit-price" id="price-lit">-- €</div>
                <div class="kit-content" id="details-lit"></div>
                <div style="padding: 20px;">
                    <button class="btn" style="width:100%;">Voir le détail</button>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="ai-widget">
    <div class="ai-header" onclick="toggleChat()">
        <span><i class="fas fa-robot"></i> Expert Solaire IA</span>
        <div>
            <i class="fas fa-cog" onclick="event.stopPropagation(); toggleKeyModal()" title="Réglages API"></i>
            <i class="fas fa-chevron-up"></i>
        </div>
    </div>
    
    <div id="api-key-modal">
        <p style="font-size:12px;">Pour activer l'IA "Intelligente", entrez votre clé OpenAI (sk-...).<br>Sinon, l'assistant utilisera des réponses basiques.</p>
        <input type="password" id="openai-key" placeholder="sk-..." style="margin-bottom:10px;">
        <button class="btn btn-add" onclick="saveKey()">Enregistrer</button>
    </div>

    <div class="ai-body" id="chat-box">
        <div class="msg bot">Bonjour ! Je suis l'assistant technique Solaris. Posez-moi n'importe quelle question sur le photovoltaïque, le câblage ou votre dimensionnement.</div>
    </div>
    <div class="ai-input-area">
        <input type="text" id="user-input" placeholder="Posez votre question..." onkeypress="handleEnter(event)">
        <button class="btn btn-add" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    // --- CONFIGURATION PRIX & TECHNIQUE ---
    const PRICING = {
        panel: 155,       // JA Solar 460W
        bat_lead: 260,    // Ultracell 150Ah
        bat_lit: 1690,    // Pylontech US5000
        multi_3k: 1150,
        multi_5k: 1950,
        mppt_s: 140,
        mppt_m: 380,
        mppt_l: 650,
        gx: 320,
        cables_base: 250, // Forfait câblage de base
        fixation_per_panel: 60
    };

    let apiKey = localStorage.getItem('openai_key') || "";

    // --- LOGIQUE CALCUL ---
    function addPreset() {
        const val = document.getElementById('quick-add').value;
        if(!val) return;
        const obj = JSON.parse(val);
        addRow(obj.n, obj.w, obj.h);
    }

    function addRow(name, w, h) {
        const tbody = document.getElementById('list');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${name}"></td>
            <td><input type="number" value="${w}" class="w-in" onchange="calcTotal()"></td>
            <td><input type="number" value="${h}" class="h-in" onchange="calcTotal()"></td>
            <td><i class="fas fa-trash" style="color:#e74c3c; cursor:pointer;" onclick="this.closest('tr').remove(); calcTotal()"></i></td>
        `;
        tbody.appendChild(tr);
        calcTotal();
    }

    function calcTotal() {
        let sum = 0;
        document.querySelectorAll('#list tr').forEach(row => {
            const w = parseFloat(row.querySelector('.w-in').value) || 0;
            const h = parseFloat(row.querySelector('.h-in').value) || 0;
            sum += w * h;
        });
        document.getElementById('total-wh').innerText = Math.round(sum);
        return sum;
    }

    function calculate() {
        const totalWh = calcTotal();
        const zone = parseFloat(document.getElementById('zone').value);
        const autonomy = parseInt(document.getElementById('autonomy').value);

        if(totalWh === 0) { alert("Veuillez ajouter des appareils."); return; }

        // 1. Panneaux
        // Prod hivernale minable = 3h * zone * 0.75 rendement
        const prodFactor = 3 * zone * 0.75;
        const panelCount = Math.ceil(totalWh / prodFactor / 460);
        const powerWc = panelCount * 460;

        // Choix MPPT & Onduleur
        let mpptName = "SmartSolar 150/35", mpptPrice = PRICING.mppt_s;
        if(powerWc > 1800) { mpptName = "SmartSolar 250/60"; mpptPrice = PRICING.mppt_m; }
        if(powerWc > 3500) { mpptName = "SmartSolar 250/100"; mpptPrice = PRICING.mppt_l; }

        let invName = "MultiPlus-II 3000VA", invPrice = PRICING.multi_3k;
        // Estimation puissance crête (somme des watts)
        let peakW = 0;
        document.querySelectorAll('.w-in').forEach(i => peakW += parseFloat(i.value)||0);
        if(peakW > 2400) { invName = "MultiPlus-II 5000VA"; invPrice = PRICING.multi_5k; }

        // 2. Batteries
        // PLOMB (Max 30% décharge jour)
        const leadWh = Math.max((totalWh * autonomy)/0.7, totalWh/0.3);
        let leadQty = Math.ceil(leadWh / (12*150));
        if(leadQty % 4 !== 0) leadQty += (4 - (leadQty % 4)); // Multiple de 4
        if(leadQty < 4) leadQty = 4;

        // LITHIUM (Max 90% décharge)
        const litWh = (totalWh * autonomy) / 0.9;
        let litQty = Math.ceil(litWh / 4800);
        if(litQty < 1) litQty = 1;

        // PRIX TOTAL
        const cableFix = PRICING.cables_base + (panelCount * PRICING.fixation_per_panel);
        
        const costLead = (panelCount*PRICING.panel) + (leadQty*PRICING.bat_lead) + invPrice + mpptPrice + PRICING.gx + cableFix;
        const costLit = (panelCount*PRICING.panel) + (litQty*PRICING.bat_lit) + invPrice + mpptPrice + PRICING.gx + cableFix;

        // AFFICHAGE
        document.getElementById('price-lead').innerText = costLead.toLocaleString() + " €";
        document.getElementById('details-lead').innerHTML = `
            <ul>
                <li><i class="fas fa-solar-panel"></i> <strong>${panelCount}x</strong> Panneaux JA Solar 460W (${powerWc}Wc)</li>
                <li><i class="fas fa-battery-full"></i> <strong>${leadQty}x</strong> Batteries Gel 150Ah (Parc ${(leadQty*12*150)/1000}kWh)</li>
                <li><i class="fas fa-bolt"></i> Onduleur ${invName}</li>
                <li><i class="fas fa-microchip"></i> Régulateur ${mpptName} + Cerbo GX</li>
                <li><i class="fas fa-tools"></i> Kit Câbles 25mm² + Coffrets AC/DC + Fixations</li>
            </ul>
        `;

        document.getElementById('price-lit').innerText = costLit.toLocaleString() + " €";
        document.getElementById('details-lit').innerHTML = `
            <ul>
                <li><i class="fas fa-solar-panel"></i> <strong>${panelCount}x</strong> Panneaux JA Solar 460W (${powerWc}Wc)</li>
                <li><i class="fas fa-battery-full"></i> <strong>${litQty}x</strong> Pylontech US5000 (${(litQty*4.8).toFixed(1)}kWh)</li>
                <li><i class="fas fa-bolt"></i> Onduleur ${invName}</li>
                <li><i class="fas fa-microchip"></i> Régulateur ${mpptName} + Cerbo GX</li>
                <li><i class="fas fa-tools"></i> Kit Câbles 25mm² + Coffrets AC/DC + Fixations</li>
            </ul>
        `;

        document.getElementById('results-section').style.display = 'block';
        document.getElementById('results-section').scrollIntoView({behavior:'smooth'});
    }

    // --- INTELLIGENCE ARTIFICIELLE (OPENAI) ---
    
    function toggleChat() {
        document.getElementById('ai-widget').classList.toggle('open');
    }

    function toggleKeyModal() {
        const m = document.getElementById('api-key-modal');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    function saveKey() {
        const k = document.getElementById('openai-key').value;
        if(k.startsWith('sk-')) {
            apiKey = k;
            localStorage.setItem('openai_key', k);
            alert("Clé enregistrée ! L'IA est maintenant active.");
            toggleKeyModal();
        } else {
            alert("Clé invalide. Elle doit commencer par 'sk-'");
        }
    }

    function handleEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value;
        if(!text) return;

        // Afficher message user
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg user">${text}</div>`;
        input.value = "";
        box.scrollTop = box.scrollHeight;

        // Préparer le "Loading"
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'msg bot';
        loadingDiv.innerText = '...';
        box.appendChild(loadingDiv);

        if(!apiKey) {
            loadingDiv.innerText = "⚠️ Clé API manquante. Cliquez sur l'engrenage pour configurer OpenAI. (Mode réponse par défaut activé)";
            setTimeout(() => {
                loadingDiv.innerText = getFallbackResponse(text);
            }, 1000);
            return;
        }

        // Appel API OpenAI
        try {
            const context = `Tu es l'assistant expert de Solaris Store. Tu es courtois, pro et technique. 
            Le client dimensionne un kit solaire.
            Détails techniques : Panneaux JA Solar 460W, Batteries Pylontech US5000 ou Ultracell Gel. Onduleurs Victron MultiPlus.
            Réponds de façon concise (max 3 phrases). Si la question est hors-sujet solaire, dis poliment que tu ne gères que le solaire.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {role: "system", content: context},
                        {role: "user", content: text}
                    ]
                })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            
            loadingDiv.innerText = data.choices[0].message.content;

        } catch (err) {
            loadingDiv.innerText = "Erreur IA : " + err.message;
        }
        
        box.scrollTop = box.scrollHeight;
    }

    function getFallbackResponse(text) {
        text = text.toLowerCase();
        if(text.includes('prix')) return "Les prix affichés incluent tout le kit complet (câbles, fixations, protections).";
        if(text.includes('batterie')) return "Nous proposons le Lithium (Pylontech) pour la longévité ou le Plomb (Ultracell) pour le budget.";
        return "Pour une réponse personnalisée précise, veuillez configurer votre clé API dans les réglages.";
    }

</script>
</body>
</html>
