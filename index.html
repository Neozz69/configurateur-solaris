<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurateur Solaris Store - Site Isol√©</title>
    <style>
        :root {
            --primary: #f39c12; /* Orange Solaris */
            --secondary: #2c3e50; /* Bleu Nuit */
            --accent: #27ae60; /* Vert validation */
            --light: #ecf0f1;
            --danger: #c0392b;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        
        header { background-color: white; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        header img { max-height: 50px; margin-right: 15px; } 
        header h1 { color: var(--secondary); margin: 0; font-size: 1.5rem; }

        .container { max-width: 1100px; margin: 30px auto; padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--light); padding-bottom: 10px; font-size: 1.2rem; }

        label { display: block; margin-top: 15px; font-weight: bold; color: var(--secondary); font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        button.action-btn { background-color: var(--secondary); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; width: 100%; font-weight: bold; font-size: 1rem; margin-top: 15px; }
        button.action-btn:hover { background-color: var(--primary); }
        
        .add-row-container { display: flex; gap: 10px; margin-top: 15px; align-items: flex-end; }
        .add-row-container select { flex-grow: 1; margin-top: 0; }
        .add-row-container button { width: auto; margin-top: 0; background-color: var(--accent); }

        .btn-remove { background-color: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; color: var(--secondary); font-size: 0.85rem; }
        th, td { text-align: left; padding: 12px 10px; border-bottom: 1px solid #eee; }
        
        .result-item { background: var(--light); padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary); border-radius: 4px; }
        .result-item h3 { margin: 0 0 5px 0; color: var(--secondary); font-size: 1rem; }
        .tech-spec { font-size: 0.9rem; color: #555; line-height: 1.5; }
        
        .warning-box { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 10px; border: 1px solid #ffeeba; display: none; }

        /* AI Chatbot */
        #chatbot { position: fixed; bottom: 20px; right: 20px; width: 320px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; height: 400px; border: 1px solid #ddd; z-index: 1000; font-family: sans-serif; }
        #chat-header { background: var(--secondary); color: white; padding: 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
        #chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; font-size: 0.9rem; }
        #chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; }
        #chat-input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 20px; outline: none; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .msg.bot { background: var(--light); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
    </style>
</head>
<body>

<header>
    <img src="https://via.placeholder.com/150x50?text=SOLARIS" alt="Solaris Logo">
    <h1>Configurateur Technique</h1>
</header>

<div class="container">
    <div class="main-content">
        
        <div class="card">
            <h2>1. Localisation</h2>
            <label>Zone G√©ographique (Ensoleillement Hiver)</label>
            <select id="zone">
                <option value="0.8">Nord / Est (Faible - Coeff 0.8)</option>
                <option value="1.0" selected>Centre / Ouest (Moyen - Coeff 1.0)</option>
                <option value="1.2">Sud / Corse (Fort - Coeff 1.2)</option>
                <option value="1.4">DOM-TOM / Afrique (Tr√®s Fort - Coeff 1.4)</option>
            </select>
        </div>

        <div class="card">
            <h2>2. Appareils & Consommation</h2>
            <div class="add-row-container">
                <select id="preset-select">
                    <option value="">-- Choisir un appareil pr√©-configur√© --</option>
                    <option value='{"name":"R√©frig√©rateur A++", "w":40, "h":24}'>R√©frig√©rateur A++ (24h/24)</option>
                    <option value='{"name":"√âclairage LED (x5)", "w":50, "h":4}'>√âclairage LED 5 ampoules (4h)</option>
                    <option value='{"name":"TV LED", "w":80, "h":3}'>TV LED (3h)</option>
                    <option value='{"name":"Box Internet", "w":15, "h":24}'>Box Internet (24h/24)</option>
                    <option value='{"name":"Chargeur Smartphone", "w":10, "h":2}'>Chargeur T√©l√©phone (2h)</option>
                    <option value='{"name":"PC Portable", "w":60, "h":4}'>Ordinateur Portable (4h)</option>
                    <option value='{"name":"Pompe √† eau", "w":800, "h":0.5}'>Pompe √† eau (30 min)</option>
                    <option value='{"name":"Micro-ondes", "w":1200, "h":0.2}'>Micro-ondes (12 min)</option>
                    <option value='{"name":"Machine √† caf√©", "w":1500, "h":0.1}'>Machine √† caf√© (6 min)</option>
                </select>
                <button onclick="addPreset()" class="action-btn" style="margin-top:0;">Ajouter</button>
            </div>
            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Ou ajoutez manuellement ci-dessous :</p>

            <table id="appliance-table">
                <thead>
                    <tr>
                        <th>Appareil</th>
                        <th>Puissance (W)</th>
                        <th>Heures/jour</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="appliance-list"></tbody>
            </table>
            <button onclick="addEmptyRow()" style="background:none; color:var(--primary); border:1px dashed var(--primary); padding:5px; width:100%; margin-top:10px; cursor:pointer;">+ Ajouter une ligne vide</button>
            
            <div style="margin-top: 20px; padding-top:10px; border-top: 2px solid #eee;">
                <strong>Consommation : <span id="total-consumption">0</span> Wh/jour</strong><br>
                <small>Puissance max instantan√©e : <span id="peak-power">0</span> W</small>
            </div>
        </div>

        <div class="card">
            <h2>3. Dimensionnement Batterie</h2>
            <label>Technologie Batterie</label>
            <select id="battery-type" onchange="updateDisclaimer()">
                <option value="lithium">Lithium (Pylontech US5000) - D√©charge 80%</option>
                <option value="lead">Plomb Gel (Ultracell 150Ah) - D√©charge Journali√®re 30%</option>
            </select>
            <div id="lead-warning" class="warning-box">
                ‚ö† Le dimensionnement Plomb respecte une d√©charge journali√®re max de 30% pour pr√©server les cycles, et 70% max en cas de coupure prolong√©e.
            </div>
            
            <label>Jours d'autonomie (Jours sans soleil)</label>
            <select id="autonomy">
                <option value="1">1 jour (Usage √©t√©/weekend)</option>
                <option value="2" selected>2 jours (Standard Habitat)</option>
                <option value="3">3 jours (S√©curit√© / Hiver)</option>
            </select>
            
            <button onclick="calculateSolarKit()" class="action-btn">CALCULER MON KIT</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="card" id="results-card" style="position: sticky; top: 20px;">
            <h2>Votre Kit Solaris</h2>
            <div id="results-content">
                <p style="color: #777; font-style: italic; text-align:center;">
                    Configurez vos appareils √† gauche pour voir le mat√©riel recommand√©.
                </p>
            </div>
        </div>
    </div>
</div>

<div id="chatbot">
    <div id="chat-header" onclick="toggleChat()">
        <span>Assistant Solaris IA</span>
        <span>‚ñº</span>
    </div>
    <div id="chat-messages">
        <div class="msg bot">Bonjour ! Besoin d'aide pour estimer la puissance de vos appareils ?</div>
    </div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Posez une question..." onkeypress="handleEnter(event)">
    </div>
</div>

<script>
    // --- DONNEES TECHNIQUES ---
    const PANEL_W = 460; // JA Solar 460W
    
    // Lithium Specs
    const BAT_LITHIUM_KWH = 4.8; // Pylontech US5000
    const DOD_LITHIUM = 0.8; // 80% utilisable pour autonomie

    // Lead Specs (Ultracell)
    const BAT_LEAD_V = 12;
    const BAT_LEAD_AH = 150;
    const BAT_LEAD_WH = BAT_LEAD_V * BAT_LEAD_AH; // 1800Wh brut par batterie
    const DOD_LEAD_AUTONOMY = 0.7; // Max 70% d√©charge totale (autonomie)
    const DOD_LEAD_DAILY = 0.3;    // Max 30% d√©charge journali√®re

    // Init
    addPreset(); // Ajoute une ligne par d√©faut (vide ou preset)

    // --- FONCTIONS ---

    function updateDisclaimer() {
        const type = document.getElementById('battery-type').value;
        const box = document.getElementById('lead-warning');
        box.style.display = (type === 'lead') ? 'block' : 'none';
    }

    function addPreset() {
        const select = document.getElementById('preset-select');
        const val = select.value;
        
        if(val) {
            const data = JSON.parse(val);
            createRow(data.name, data.w, data.h);
            select.value = ""; // Reset select
        } else {
            // Si rien s√©lectionn√© et appel manuel (ou init), on ajoute ligne vide si demand√© explicitement
            // Ici, addPreset est appel√© par le bouton "Ajouter".
        }
        updateTotals();
    }

    function addEmptyRow() {
        createRow("", "", "");
    }

    function createRow(name, watts, hours) {
        const tbody = document.getElementById('appliance-list');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" value="${name}" placeholder="Nom de l'appareil"></td>
            <td><input type="number" value="${watts}" placeholder="W" class="watts-input" onchange="updateTotals()"></td>
            <td><input type="number" value="${hours}" placeholder="H" class="hours-input" onchange="updateTotals()"></td>
            <td><button class="btn-remove" onclick="removeRow(this)">X</button></td>
        `;
        tbody.appendChild(row);
        updateTotals();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        updateTotals();
    }

    function updateTotals() {
        let totalWh = 0;
        let peakW = 0;
        
        document.querySelectorAll('#appliance-list tr').forEach(row => {
            const w = parseFloat(row.querySelector('.watts-input').value) || 0;
            const h = parseFloat(row.querySelector('.hours-input').value) || 0;
            totalWh += w * h;
            peakW += w;
        });

        document.getElementById('total-consumption').innerText = Math.ceil(totalWh);
        document.getElementById('peak-power').innerText = Math.ceil(peakW);
        return { totalWh, peakW };
    }

    function calculateSolarKit() {
        const { totalWh, peakW } = updateTotals();
        const zoneFactor = parseFloat(document.getElementById('zone').value);
        const batteryType = document.getElementById('battery-type').value;
        const autonomyDays = parseInt(document.getElementById('autonomy').value);

        if (totalWh === 0) {
            alert("Merci d'ajouter au moins un appareil.");
            return;
        }

        // 1. CALCUL PANNEAUX
        // On base la prod sur l'hiver (le pire cas)
        // Besoin journalier / (HSE Hiver * Coeff Zone * Rendement Syst√®me)
        // HSE Hiver base France = ~2.5 √† 3h
        const hseWinter = 3; 
        const systemEfficiency = 0.75; // Pertes c√¢bles, onduleur, temp√©rature
        const productionMin = hseWinter * zoneFactor * systemEfficiency;
        
        const requiredWp = totalWh / productionMin;
        const panelCount = Math.ceil(requiredWp / PANEL_W);
        const arrayPower = panelCount * PANEL_W;

        // 2. CALCUL BATTERIE
        let batteryHtml = "";
        let batIcon = "üîã";

        if (batteryType === 'lithium') {
            // Logique Lithium : Autonomie conditionne le pack
            const energyNeed = totalWh * autonomyDays;
            const usefulCapacityPerBat = BAT_LITHIUM_KWH * 1000 * DOD_LITHIUM; // Wh utilisables
            const nbBat = Math.ceil(energyNeed / usefulCapacityPerBat);
            
            const totalCapKwh = (nbBat * BAT_LITHIUM_KWH).toFixed(1);
            batteryHtml = `<strong>${nbBat}x Pylontech US5000</strong><br>
                           Capacit√© totale : ${totalCapKwh} kWh<br>
                           <small>Bas√© sur une d√©charge max de ${(DOD_LITHIUM*100)}%</small>`;
        
        } else {
            // Logique Plomb (Ultracell 150Ah 12V)
            // Contrainte 1 : Autonomie (Max 70% d√©charge totale)
            const capacityForAutonomy = (totalWh * autonomyDays) / DOD_LEAD_AUTONOMY;
            
            // Contrainte 2 : Cycle journalier (Max 30% d√©charge quotidienne)
            // On dimensionne le parc pour que la consommation d'un jour ne repr√©sente que 30% du total
            const capacityForDaily = totalWh / DOD_LEAD_DAILY;

            // On prend le plus grand des deux besoins
            const finalCapacityWh = Math.max(capacityForAutonomy, capacityForDaily);
            
            // Nombre de batteries 12V 150Ah
            let nbBat = Math.ceil(finalCapacityWh / BAT_LEAD_WH);

            // Ajustement pour syst√®me 48V (Multiple de 4 obligatoire pour MultiPlus 48V)
            // Si on a besoin de 5 batteries, on passe √† 8 (2 cha√Ænes de 4)
            const remainder = nbBat % 4;
            if (remainder !== 0) {
                nbBat = nbBat + (4 - remainder);
            }
            if (nbBat < 4) nbBat = 4; // Minimum 48V

            const totalAh48V = (nbBat / 4) * 150; // Capacit√© en Ah sous 48V
            
            batteryHtml = `<strong>${nbBat}x Ultracell GEL 12V 150Ah</strong><br>
                           Montage : ${(nbBat/4)} cha√Æne(s) de 4 en s√©rie (48V)<br>
                           Capacit√© totale parc : ${totalAh48V}Ah en 48V<br>
                           <small class="text-warning">Respecte la limite de 30% d√©charge/jour</small>`;
        }

        // 3. ONDULEUR & REGULATEUR
        // S√©lection Victron MultiPlus-II
        const powerMargin = peakW * 1.3; // +30% marge d√©marrage/s√©curit√©
        let inverter = "MultiPlus-II 48/3000/35";
        if (powerMargin > 2400) inverter = "MultiPlus-II 48/5000/70";
        if (powerMargin > 4000) inverter = "MultiPlus-II 48/8000/110";
        if (powerMargin > 6500) inverter = "MultiPlus-II 48/10000";

        // S√©lection MPPT
        // Tension Voc string vs Courant charge
        let mppt = "SmartSolar MPPT 150/35";
        if (panelCount > 3) mppt = "SmartSolar MPPT 250/60";
        if (panelCount > 6) mppt = "SmartSolar MPPT 250/85";
        if (panelCount > 9) mppt = "SmartSolar MPPT 250/100";

        // RENDU HTML
        const resultDiv = document.getElementById('results-content');
        resultDiv.innerHTML = `
            <div class="result-item">
                <h3>‚òÄÔ∏è Champ PV JA Solar</h3>
                <div class="tech-spec">
                    Quantit√© : <strong>${panelCount} panneaux</strong> (460W)<br>
                    Puissance Cr√™te : ${arrayPower} Wc
                </div>
            </div>

            <div class="result-item">
                <h3>‚ö° Parc Batterie</h3>
                <div class="tech-spec">
                    ${batteryHtml}
                </div>
            </div>

            <div class="result-item">
                <h3>üîå Conversion & Gestion</h3>
                <div class="tech-spec">
                    Onduleur : <strong>${inverter}</strong><br>
                    R√©gulateur : <strong>${mppt}</strong><br>
                    Syst√®me GX : <strong>Cerbo GX + Touch 50</strong>
                </div>
            </div>
            
            <div style="text-align:center; margin-top:15px;">
                <button style="background:#27ae60; color:white; border:none; padding:15px; width:100%; border-radius:5px; font-size:1.1rem; cursor:pointer;">
                    Demander devis pour ce kit
                </button>
            </div>
        `;
    }

    // --- CHATBOT ---
    function toggleChat() {
        const chat = document.getElementById('chatbot');
        if (chat.style.height === '40px') chat.style.height = '400px';
        else chat.style.height = '400px'; // Force open
    }

    function handleEnter(e) {
        if (e.key === 'Enter') {
            const input = document.getElementById('chat-input');
            const val = input.value;
            if(!val) return;
            addMsg(val, 'user');
            input.value = '';
            setTimeout(()=> botReply(val), 500);
        }
    }

    function addMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        const c = document.getElementById('chat-messages');
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    function botReply(text) {
        text = text.toLowerCase();
        let rep = "Je peux vous aider √† dimensionner votre kit. Parlez-moi de vos appareils.";
        
        if(text.includes('plomb') || text.includes('gel')) rep = "Pour le plomb (Ultracell), nous limitons la d√©charge journali√®re √† 30% pour garantir une dur√©e de vie de 5 √† 7 ans minimum.";
        if(text.includes('lithium') || text.includes('us5000')) rep = "La Pylontech US5000 accepte des d√©charges profondes (80-90%). C'est plus cher √† l'achat mais bien plus rentable sur 10 ans.";
        if(text.includes('frigo')) rep = "Un frigo A++ consomme environ 40W en moyenne liss√©e sur 24h (soit ~1000Wh/jour).";
        if(text.includes('tv')) rep = "Une TV LED moderne consomme entre 50 et 100W selon la taille.";
        
        addMsg(rep, 'bot');
    }
</script>

</body>
</html>
